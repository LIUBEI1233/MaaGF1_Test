# 静默沙盘炼金术

## 一、食用方式

### 1.1 流程

1. 梯队1和梯队2使用两个铁血梯队；
2. “确认出击”至如下有剧情对话的位置，如图1所示：

![图1](../assets/resource/image/sandbox_resource/00_skip.png)

3. 在上述界面直接开启脚本即可，每次执行会弹出一个powershell脚本用于地图缩放，属于正常现象。

## 1.2 注意

1. 铁血梯队不应配备“鬼步”（鬼影姿态）芯片；
2. 如果在“补给阶段”（见下方状态机）卡住，请关闭脚本手动执行补给，并结束本次循环。

## 1.3 TODO

目前只针对了`state 第一轮战斗`做了完整的识别保护，后续如果有需要，还需要对第二轮战斗和补给铁血部分做识别保护。

## 二、状态机

简化状态机如下：

```
stateDiagram-v2
    [*] --> 初始化阶段 : 开始
    
    state 初始化阶段 {
        [*] --> 跳过剧情
        跳过剧情 --> 地图调整
        地图调整 --> [*]
    }
    
    初始化阶段 --> 部署阶段 : 初始化完成
    
    state 部署阶段 {
        [*] --> 右侧机场部署
        右侧机场部署 --> 左侧机场部署
        左侧机场部署 --> [*]
    }
    
    部署阶段 --> 战斗准备阶段 : 部署完成
    
    state 战斗准备阶段 {
        [*] --> 跳过战斗剧情
        跳过战斗剧情 --> 关闭任务简报
        关闭任务简报 --> [*]
    }
    
    战斗准备阶段 --> 第一轮战斗阶段 : 准备完成
    
    state 第一轮战斗阶段 {
        [*] --> 战斗循环
        战斗循环 --> 战斗循环 : 未到第5回合
        战斗循环 --> 执行计划 : 第5回合
        执行计划 --> 制造补给
        制造补给 --> [*]
    }
    
    第一轮战斗阶段 --> 第二轮战斗阶段 : 第一轮完成
    
    state 第二轮战斗阶段 {
        [*] --> 指挥官移动
        指挥官移动 --> 铁血梯队补给
        铁血梯队补给 --> [*]
    }
    
    第二轮战斗阶段 --> 结算阶段 : 战斗完成
    
    state 结算阶段 {
        [*] --> 处理结算
        处理结算 --> 再次作战
        再次作战 --> [*]
    }
    
    结算阶段 --> 初始化阶段 : 开始新循环
```

完整状态机如下：

```
stateDiagram-v2
    [*] --> 主循环 : 开始

    主循环 --> 剧情对话_00 : 进入沙盒
    剧情对话_00 --> 点击跳过_00 : 检测到跳过按钮
    点击跳过_00 --> 缩小地图 : 跳过完成

    缩小地图 --> 地图平移1 : 缩放完成
    地图平移1 --> 地图平移2 : 平移1完成
    地图平移2 --> 部署铁血_R_点击机场 : 平移2完成

    state 右侧机场部署 {
        部署铁血_R_点击机场 --> 部署铁血_R_部署_点击确定 : 检测到"确定"
        部署铁血_R_点击机场 --> 部署铁血_R_已部署_点击取消 : 检测到"取消"
        部署铁血_R_点击机场 --> 部署铁血_R_重装部队_被选中 : 检测到重装部队
        
        部署铁血_R_重装部队_被选中 --> 部署铁血_R_重装部队_切换到普通梯队 : 检测到部署界面
        部署铁血_R_重装部队_切换到普通梯队 --> 部署铁血_R_部署_点击确定 : 切换完成
    }

    部署铁血_R_部署_点击确定 --> 部署铁血_L_点击机场 : 右侧部署完成
    部署铁血_R_已部署_点击取消 --> 部署铁血_L_点击机场 : 右侧已部署

    state 左侧机场部署 {
        部署铁血_L_点击机场 --> 部署铁血_L_部署_点击确定 : 检测到"确定"
        部署铁血_L_点击机场 --> 部署铁血_L_已部署_点击取消 : 检测到"取消"
        部署铁血_L_点击机场 --> 部署铁血_L_重装部队_被选中 : 检测到重装部队
        
        部署铁血_L_重装部队_被选中 --> 部署铁血_L_重装部队_切换到普通梯队 : 检测到部署界面
        部署铁血_L_重装部队_切换到普通梯队 --> 部署铁血_L_部署_点击确定 : 切换完成
    }

    部署铁血_L_部署_点击确定 --> 作战开始 : 左侧部署完成
    部署铁血_L_已部署_点击取消 --> 作战开始 : 左侧已部署

    作战开始 --> 剧情对话_01 : 作战开始
    剧情对话_01 --> 点击跳过_01 : 检测到跳过按钮
    点击跳过_01 --> 任务简报 : 跳过完成
    任务简报 --> 关闭简报 : 检测到关闭按钮
    关闭简报 --> 战斗阶段_初始状态判断 : 关闭完成

    战斗阶段_初始状态判断 --> 战斗阶段_计划模式_1_Begin : 检测到回合1

    state 第一轮战斗循环 {
        战斗阶段_计划模式_1_Begin --> 战斗阶段_计划模式_1_点击计划_Begin : 点击空白
        
        state 计划模式检测 {
            战斗阶段_计划模式_1_点击计划_Begin --> 战斗阶段_计划模式_1_点击计划_生效判断 : 点击计划
            战斗阶段_计划模式_1_点击计划_生效判断 --> 战斗阶段_计划模式_1_点击计划_检查是否进入计划模式 : 检查模式
            战斗阶段_计划模式_1_点击计划_生效判断 --> 战斗阶段_计划模式_1_点击计划_重新点击 : 未进入
            战斗阶段_计划模式_1_点击计划_检查是否进入计划模式 --> 战斗阶段_计划模式_1_铁血_R_点击梯队 : 进入计划模式
            战斗阶段_计划模式_1_点击计划_重新点击 --> 战斗阶段_计划模式_1_点击计划_Begin : 重新尝试
        }
        
        state 梯队操作序列 {
            战斗阶段_计划模式_1_铁血_R_点击梯队 --> 战斗阶段_计划模式_1_铁血_R_点击目标地点
            战斗阶段_计划模式_1_铁血_R_点击目标地点 --> 战斗阶段_计划模式_1_铁血_R_点击空白位置
            战斗阶段_计划模式_1_铁血_R_点击空白位置 --> 战斗阶段_计划模式_1_铁血_L_点击梯队
            战斗阶段_计划模式_1_铁血_L_点击梯队 --> 战斗阶段_计划模式_1_铁血_L_点击目标地点
            战斗阶段_计划模式_1_铁血_L_点击目标地点 --> 战斗阶段_计划模式_1_铁血_L_点击空白位置
            战斗阶段_计划模式_1_铁血_L_点击空白位置 --> 战斗阶段_计划模式_1_指挥官_点击梯队
            战斗阶段_计划模式_1_指挥官_点击梯队 --> 战斗阶段_计划模式_1_指挥官_杂鱼_R
            战斗阶段_计划模式_1_指挥官_杂鱼_R --> 战斗阶段_计划模式_1_指挥官_杂鱼_U
            战斗阶段_计划模式_1_指挥官_杂鱼_U --> 战斗阶段_计划模式_1_指挥官_返回初始位置
        }
        
        战斗阶段_计划模式_1_指挥官_返回初始位置 --> 战斗阶段_计划模式_1_回合判断 : 操作完成
        
        state 回合判断 {
            战斗阶段_计划模式_1_回合判断 --> 战斗阶段_计划模式_1_检查回合5 : 检查回合
            战斗阶段_计划模式_1_回合判断 --> 战斗阶段_计划模式_1_继续循环 : 检查回合
            战斗阶段_计划模式_1_检查回合5 --> 战斗阶段_计划模式_1_执行计划 : 第5回合
            战斗阶段_计划模式_1_继续循环 --> 战斗阶段_计划模式_1_Begin : 继续战斗
        }
    }

    战斗阶段_计划模式_1_执行计划 --> 战斗阶段_指挥官_制造补给_判断 : 执行完成
    战斗阶段_指挥官_制造补给_判断 --> 战斗阶段_指挥官_制造补给_点击制造 : 检测到制造按钮
    战斗阶段_指挥官_制造补给_点击制造 --> 地图平移3 : 制造完成

    地图平移3 --> 战斗阶段_计划模式_2_点击空白位置 : 平移完成

    state 第二轮战斗 {
        战斗阶段_计划模式_2_点击空白位置 --> 战斗阶段_计划模式_2_点击计划
        战斗阶段_计划模式_2_点击计划 --> 战斗阶段_计划模式_2_指挥官_点击梯队
        战斗阶段_计划模式_2_指挥官_点击梯队 --> 战斗阶段_计划模式_2_指挥官_点击目标地点
        战斗阶段_计划模式_2_指挥官_点击目标地点 --> 战斗阶段_计划模式_2_执行计划
    }

    战斗阶段_计划模式_2_执行计划 --> 战斗阶段_指挥官_执行补给_铁血R_判断 : 执行完成

    state 补给阶段 {
        战斗阶段_指挥官_执行补给_铁血R_判断 --> 战斗阶段_指挥官_执行补给_铁血R_使用装置 : 检测到补给按钮
        战斗阶段_指挥官_执行补给_铁血R_使用装置 --> 战斗阶段_指挥官_执行补给_铁血R_点击梯队
        战斗阶段_指挥官_执行补给_铁血R_点击梯队 --> 战斗阶段_指挥官_执行补给_铁血L_判断
        战斗阶段_指挥官_执行补给_铁血L_判断 --> 战斗阶段_指挥官_执行补给_铁血L_使用装置 : 检测到补给按钮
        战斗阶段_指挥官_执行补给_铁血L_使用装置 --> 战斗阶段_指挥官_执行补给_铁血L_点击梯队
    }

    战斗阶段_指挥官_执行补给_铁血L_点击梯队 --> 结算_判断 : 补给完成

    state 结算阶段 {
        结算_判断 --> 结算_点击战役结算 : 检测到结算界面
        结算_点击战役结算 --> 结算_确定
        结算_确定 --> 再次作战_1
        再次作战_1 --> 再次作战_2
        再次作战_2 --> 再次作战_3
    }

    再次作战_3 --> 主循环 : 开始新循环
```