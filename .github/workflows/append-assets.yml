name: Append Assets

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  append-external-artifacts:
    name: Append Docs & LogDog
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Read Configuration
        id: config
        shell: bash
        run: |
          logdog_repo=$(python -c "import configparser; c = configparser.ConfigParser(); c.read('mk/.conf'); print(c['install']['logdog_repo'])")
          logdog_tag=$(python -c "import configparser; c = configparser.ConfigParser(); c.read('mk/.conf'); print(c['install']['logdog_tag'])")
          
          docs_repo=$(python -c "import configparser; c = configparser.ConfigParser(); c.read('mk/.conf'); print(c['install']['docs_repo'])")
          docs_tag=$(python -c "import configparser; c = configparser.ConfigParser(); c.read('mk/.conf'); print(c['install']['docs_tag'])")
          
          echo "logdog_repo=$logdog_repo" >> $GITHUB_OUTPUT
          echo "logdog_tag=$logdog_tag" >> $GITHUB_OUTPUT
          echo "docs_repo=$docs_repo" >> $GITHUB_OUTPUT
          echo "docs_tag=$docs_tag" >> $GITHUB_OUTPUT
          
          echo "::group::Configuration Loaded"
          echo "LogDog: $logdog_repo @ $logdog_tag"
          echo "Docs:   $docs_repo @ $docs_tag"
          echo "::endgroup::"

      # 1. Download LogDog
      - name: Download LogDog Artifacts
        uses: robinraju/release-downloader@v1
        with:
          repository: ${{ steps.config.outputs.logdog_repo }}
          fileName: "*"
          latest: ${{ steps.config.outputs.logdog_tag == 'latest' }}
          tag: ${{ steps.config.outputs.logdog_tag != 'latest' && steps.config.outputs.logdog_tag || '' }}
          out-file-path: "assets_buffer/logdog"

      # 2. Download Docs
      - name: Download Docs Artifacts
        uses: robinraju/release-downloader@v1
        with:
          repository: ${{ steps.config.outputs.docs_repo }}
          fileName: "*"
          latest: ${{ steps.config.outputs.docs_tag == 'latest' }}
          tag: ${{ steps.config.outputs.docs_tag != 'latest' && steps.config.outputs.docs_tag || '' }}
          out-file-path: "assets_buffer/docs"

      # 3. List Artifacts
      - name: List Downloaded Assets
        run: |
          echo "Downloaded files:"
          find assets_buffer -type f

      # 4. Upload to Release
      - name: Upload to Current Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            assets_buffer/logdog/*
            assets_buffer/docs/*
          tag_name: ${{ github.event.release.tag_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}