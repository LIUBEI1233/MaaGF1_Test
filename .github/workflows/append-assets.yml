name: Append External Assets

# 仅在 Release 发布成功后触发
on:
  release:
    types: [published]

permissions:
  contents: write # 需要写权限来上传文件到 Release

jobs:
  append-external-artifacts:
    name: Append Docs & LogDog
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Read Configuration
        id: config
        shell: bash
        run: |
          # 使用 Python 解析 INI 配置，保持与 install.yml 一致的风格
          logdog_repo=$(python -c "import configparser; c = configparser.ConfigParser(); c.read('mk/.conf'); print(c['install']['logdog_repo'])")
          logdog_tag=$(python -c "import configparser; c = configparser.ConfigParser(); c.read('mk/.conf'); print(c['install']['logdog_tag'])")
          
          docs_repo=$(python -c "import configparser; c = configparser.ConfigParser(); c.read('mk/.conf'); print(c['install']['docs_repo'])")
          docs_tag=$(python -c "import configparser; c = configparser.ConfigParser(); c.read('mk/.conf'); print(c['install']['docs_tag'])")
          
          echo "logdog_repo=$logdog_repo" >> $GITHUB_OUTPUT
          echo "logdog_tag=$logdog_tag" >> $GITHUB_OUTPUT
          echo "docs_repo=$docs_repo" >> $GITHUB_OUTPUT
          echo "docs_tag=$docs_tag" >> $GITHUB_OUTPUT
          
          echo "::group::Configuration Loaded"
          echo "LogDog: $logdog_repo @ $logdog_tag"
          echo "Docs:   $docs_repo @ $docs_tag"
          echo "::endgroup::"

      # 1. 下载 LogDog
      - name: Download LogDog Artifacts
        uses: robinraju/release-downloader@v1
        with:
          repository: ${{ steps.config.outputs.logdog_repo }}
          # 下载所有文件 (*)，也可以指定具体文件名
          fileName: "*"
          latest: ${{ steps.config.outputs.logdog_tag == 'latest' }}
          tag: ${{ steps.config.outputs.logdog_tag != 'latest' && steps.config.outputs.logdog_tag || '' }}
          out-file-path: "assets_buffer/logdog"

      # 2. 下载 Docs
      - name: Download Docs Artifacts
        uses: robinraju/release-downloader@v1
        with:
          repository: ${{ steps.config.outputs.docs_repo }}
          fileName: "*"
          latest: ${{ steps.config.outputs.docs_tag == 'latest' }}
          tag: ${{ steps.config.outputs.docs_tag != 'latest' && steps.config.outputs.docs_tag || '' }}
          out-file-path: "assets_buffer/docs"

      # 3. 整理文件 (可选)
      # 如果你想重命名文件，或者把它们扁平化，可以在这里处理
      # 这里我们假设直接上传下载下来的文件
      - name: List Downloaded Assets
        run: |
          echo "Downloaded files:"
          find assets_buffer -type f

      # 4. 上传到当前的 Release
      - name: Upload to Current Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          # 指向 assets_buffer 下的所有文件
          files: |
            assets_buffer/logdog/*
            assets_buffer/docs/*
          # 这里的 tag_name 使用触发当前 workflow 的 tag
          tag_name: ${{ github.event.release.tag_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}